<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Investment Analysis - SQL Queries Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        h2 {
            color: #c0392b;
            margin-top: 30px;
            border-left: 4px solid #e74c3c;
            padding-left: 15px;
        }
        h3 {
            color: #27ae60;
            margin-top: 25px;
        }
        .query-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .sql-code {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .difficulty-easy {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
        }
        .difficulty-medium {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        .difficulty-hard {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 10px 0;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .business-impact {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .technical-note {
            background-color: #f0f8ff;
            border: 1px solid #91b7e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        .toc li {
            margin: 8px 0;
        }
        .toc a {
            color: #2980b9;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
        }
        .sql-keyword {
            color: #ff7b72;
            font-weight: bold;
        }
        .sql-string {
            color: #a5d6ff;
        }
        .sql-number {
            color: #79c0ff;
        }
        .sql-comment {
            color: #8b949e;
            font-style: italic;
        }
        .author-info {
            background-color: #f8f9fa;
            border-top: 2px solid #e74c3c;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè† Real Estate Investment Analysis<br>SQL Queries Documentation</h1>
        
        <div class="business-impact">
            <h3>üéØ Project Overview</h3>
            <p><strong>Real Estate Investment Analysis Platform</strong> - A comprehensive data analysis system for identifying optimal real estate investment opportunities through advanced SQL analytics, financial modeling, and geographic intelligence.</p>
            
            <div class="key-metrics">
                <div class="metric-card">
                    <div class="metric-value">5</div>
                    <div>SQL Queries</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">250+</div>
                    <div>Properties Analyzed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">12</div>
                    <div>Market Areas</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">8.2%</div>
                    <div>Avg Cap Rate</div>
                </div>
            </div>
        </div>

        <div class="toc">
            <h3>üìã Table of Contents</h3>
            <ul>
                <li><a href="#query1">Query 1: Basic Property Overview (EASY)</a></li>
                <li><a href="#query2">Query 2: Location-Based Price Analysis (EASY)</a></li>
                <li><a href="#query3">Query 3: Investment ROI Calculator (MEDIUM)</a></li>
                <li><a href="#query4">Query 4: Market Trends Analysis (MEDIUM)</a></li>
                <li><a href="#query5">Query 5: Advanced Investment Scoring Algorithm (MEDIUM-HARD)</a></li>
                <li><a href="#technical-details">Technical Implementation Details</a></li>
                <li><a href="#business-applications">Business Applications</a></li>
            </ul>
        </div>

        <!-- Query 1 -->
        <div id="query1">
            <h2>Query 1: Basic Property Overview</h2>
            <div class="difficulty-easy">
                <strong>Difficulty Level: EASY</strong> | Basic aggregations and data exploration
            </div>
            
            <h3>Business Purpose</h3>
            <p>Provides fundamental insights into the real estate dataset including total property count, average prices, and basic characteristics. This serves as the foundation for all subsequent analyses.</p>
            
            <div class="business-impact">
                <h4>üìä Key Insights Delivered:</h4>
                <ul>
                    <li><strong>Market Scale</strong>: Total properties available for analysis</li>
                    <li><strong>Price Benchmarks</strong>: Average, minimum, and maximum property prices</li>
                    <li><strong>Property Characteristics</strong>: Average bedrooms, bathrooms, and square footage</li>
                    <li><strong>Property Type Distribution</strong>: Breakdown by Single Family, Townhouse, Condo</li>
                </ul>
            </div>

            <div class="business-impact">
                <strong>Business Question:</strong> What is the overall scope and characteristics of our real estate investment market?
            </div>

            <div class="query-block">
                <h4>SQL Implementation</h4>
                <div class="sql-code">-- Real Estate Investment Analysis - Query 1: Basic Property Overview
-- Difficulty Level: EASY
-- Purpose: Basic data exploration and property statistics

SELECT 
    COUNT(*) as total_properties,
    AVG(price) as avg_property_price,
    MIN(price) as min_price,
    MAX(price) as max_price,
    AVG(bedrooms) as avg_bedrooms,
    AVG(bathrooms) as avg_bathrooms,
    AVG(square_feet) as avg_square_feet
FROM properties 
WHERE price > 0 AND price < 10000000;  -- Filter out outliers

-- Property type breakdown
SELECT 
    property_type,
    COUNT(*) as property_count,
    AVG(price) as avg_price_by_type
FROM properties 
WHERE price > 0 
GROUP BY property_type 
ORDER BY property_count DESC;</div>
            </div>

            <div class="explanation">
                <h4>üîç Step-by-Step Explanation:</h4>
                <ol>
                    <li><strong>COUNT(*):</strong> Counts total properties to understand market size</li>
                    <li><strong>AVG(price):</strong> Calculates average property price as market benchmark</li>
                    <li><strong>MIN/MAX(price):</strong> Shows price range for investment budget planning</li>
                    <li><strong>AVG(bedrooms/bathrooms):</strong> Typical property characteristics for comparisons</li>
                    <li><strong>AVG(square_feet):</strong> Average property size for price per sqft calculations</li>
                    <li><strong>WHERE price > 0 AND price < 10000000:</strong> Filters out invalid data and extreme outliers</li>
                    <li><strong>GROUP BY property_type:</strong> Breaks down market by Single Family, Townhouse, Condo</li>
                    <li><strong>ORDER BY property_count DESC:</strong> Shows most common property types first</li>
                </ol>
            </div>

            <div class="technical-note">
                <h4>üîß Technical Notes:</h4>
                <ul>
                    <li><strong>Data Quality</strong>: Filters out properties with $0 price or extreme outliers (>$10M)</li>
                    <li><strong>Aggregation Functions</strong>: Uses COUNT(), AVG(), MIN(), MAX() for comprehensive overview</li>
                    <li><strong>Grouping Logic</strong>: Groups by property_type to understand market composition</li>
                </ul>
            </div>
        </div>

        <!-- Query 2 -->
        <div id="query2">
            <h2>Query 2: Location-Based Price Analysis</h2>
            <div class="difficulty-easy">
                <strong>Difficulty Level: EASY</strong> | Geographic aggregations and ranking
            </div>

            <h3>Business Purpose</h3>
            <p>Analyzes property prices by geographic location (state, city, zip code) to identify high-value markets, affordable opportunities, and optimal investment locations based on rental yield potential.</p>

            <div class="business-impact">
                <h4>üó∫Ô∏è Geographic Intelligence:</h4>
                <ul>
                    <li><strong>State Rankings</strong>: Identifies most expensive and affordable states</li>
                    <li><strong>City Hotspots</strong>: Top 10 most expensive cities for market targeting</li>
                    <li><strong>Zip Code Opportunities</strong>: High rental yield areas for investment focus</li>
                    <li><strong>Price per Square Foot</strong>: Geographic efficiency metrics</li>
                </ul>
            </div>

            <div class="business-impact">
                <strong>Business Question:</strong> Which geographic markets offer the best investment opportunities based on price levels and rental yield potential?
            </div>

            <div class="query-block">
                <h4>Key Geographic Analysis</h4>
                <div class="sql-code">-- Top 10 most expensive cities
SELECT 
    city, state,
    COUNT(*) as property_count,
    AVG(price) as avg_price,
    ROUND(AVG(price_per_sqft), 2) as avg_price_per_sqft
FROM properties 
WHERE price > 0 AND square_feet > 0
GROUP BY city, state 
HAVING COUNT(*) >= 5  -- Only cities with at least 5 properties
ORDER BY avg_price DESC 
LIMIT 10;

-- Investment opportunities by rental yield
SELECT 
    zip_code, city, state,
    COUNT(*) as available_properties,
    AVG(price) as avg_price,
    AVG(estimated_rental_income) as avg_rental_income,
    ROUND(AVG(estimated_rental_income * 12 / price * 100), 2) as rental_yield_percent
FROM properties 
WHERE price > 0 AND estimated_rental_income > 0
GROUP BY zip_code, city, state
HAVING COUNT(*) >= 3
ORDER BY rental_yield_percent DESC 
LIMIT 20;</div>
            </div>

            <div class="explanation">
                <h4>üîç Step-by-Step Explanation:</h4>
                <ol>
                    <li><strong>GROUP BY city, state:</strong> Groups properties by geographic location for comparison</li>
                    <li><strong>COUNT(*) as property_count:</strong> Shows market size and data reliability per city</li>
                    <li><strong>AVG(price) as avg_price:</strong> Average property price to identify high-value markets</li>
                    <li><strong>AVG(price_per_sqft):</strong> Price efficiency metric for fair comparisons across property sizes</li>
                    <li><strong>HAVING COUNT(*) >= 5:</strong> Filters out cities with insufficient data (< 5 properties)</li>
                    <li><strong>Rental yield calculation:</strong> (Annual rental √∑ price) √ó 100 for ROI comparison</li>
                    <li><strong>ORDER BY rental_yield_percent DESC:</strong> Prioritizes highest cash-flow opportunities</li>
                    <li><strong>LIMIT 20:</strong> Focus on top investment opportunities</li>
                </ol>
            </div>

            <div class="highlight">
                <strong>üí° Business Insight:</strong> This analysis helps investors identify "cash cow" markets where rental yields exceed 10-12%, indicating strong income-generating potential.
            </div>
        </div>

        <!-- Query 3 -->
        <div id="query3">
            <h2>Query 3: Investment ROI Calculator</h2>
            <div class="difficulty-medium">
                <strong>Difficulty Level: MEDIUM</strong> | Financial calculations with CTEs
            </div>

            <h3>Business Purpose</h3>
            <p>Comprehensive ROI analysis for rental property investments including cash-on-cash return, cap rates, and profitability screening. This query transforms raw property data into actionable investment metrics.</p>

            <div class="business-impact">
                <h4>üí∞ Financial Modeling Capabilities:</h4>
                <ul>
                    <li><strong>Cash Flow Analysis</strong>: Monthly cash flow after all expenses</li>
                    <li><strong>Cash-on-Cash Return</strong>: Return percentage on invested capital</li>
                    <li><strong>Cap Rate Calculation</strong>: Annual rental income / purchase price</li>
                    <li><strong>Investment Filtering</strong>: Only shows profitable properties</li>
                </ul>
            </div>

            <div class="business-impact">
                <strong>Business Question:</strong> Which properties offer the best return on investment when considering all financing costs, taxes, and maintenance expenses?
            </div>

            <div class="query-block">
                <h4>Advanced Financial Calculations</h4>
                <div class="sql-code">WITH investment_metrics AS (
    SELECT 
        property_id,
        address,
        city,
        state,
        price,
        bedrooms,
        bathrooms,
        square_feet,
        estimated_rental_income,
        property_taxes,
        
        -- Basic investment calculations
        (estimated_rental_income * 12) as annual_rental_income,
        (price * 0.20) as down_payment_20_percent,
        (price * 0.80 * 0.045 / 12) as monthly_mortgage_payment, -- 4.5% interest
        (property_taxes / 12) as monthly_property_taxes,
        (estimated_rental_income * 0.08) as monthly_maintenance_reserve, -- 8% for maintenance
        
        -- Price per square foot
        ROUND(price / NULLIF(square_feet, 0), 2) as price_per_sqft
        
    FROM properties 
    WHERE price > 0 
      AND estimated_rental_income > 0 
      AND property_taxes > 0
      AND square_feet > 0
)

SELECT 
    property_id,
    address,
    city,
    state,
    price,
    bedrooms,
    bathrooms,
    square_feet,
    price_per_sqft,
    
    -- Rental metrics
    estimated_rental_income as monthly_rent,
    annual_rental_income,
    
    -- Investment calculations
    down_payment_20_percent,
    monthly_mortgage_payment,
    monthly_property_taxes,
    monthly_maintenance_reserve,
    
    -- Total monthly expenses
    (monthly_mortgage_payment + monthly_property_taxes + monthly_maintenance_reserve) as total_monthly_expenses,
    
    -- Monthly cash flow
    (estimated_rental_income - (monthly_mortgage_payment + monthly_property_taxes + monthly_maintenance_reserve)) as monthly_cash_flow,
    
    -- Annual cash flow
    ((estimated_rental_income - (monthly_mortgage_payment + monthly_property_taxes + monthly_maintenance_reserve)) * 12) as annual_cash_flow,
    
    -- Cash-on-Cash Return (Annual cash flow / Down payment)
    ROUND(
        ((estimated_rental_income - (monthly_mortgage_payment + monthly_property_taxes + monthly_maintenance_reserve)) * 12) 
        / NULLIF(down_payment_20_percent, 0) * 100, 2
    ) as cash_on_cash_return_percent,
    
    -- Cap Rate (Annual rental income / Purchase price)
    ROUND(annual_rental_income / NULLIF(price, 0) * 100, 2) as cap_rate_percent,
    
    -- Rent-to-Price Ratio (Monthly rent / Purchase price)
    ROUND(estimated_rental_income / NULLIF(price, 0) * 100, 4) as rent_to_price_ratio

FROM investment_metrics
WHERE estimated_rental_income > (monthly_mortgage_payment + monthly_property_taxes + monthly_maintenance_reserve) -- Only profitable properties
ORDER BY cash_on_cash_return_percent DESC
LIMIT 25;</div>
            </div>

            <div class="explanation">
                <h4>üîç Step-by-Step Explanation:</h4>
                <ol>
                    <li><strong>CTE (investment_metrics):</strong> Creates a temporary table with calculated financial metrics</li>
                    <li><strong>Down payment calculation:</strong> 20% of purchase price for realistic financing</li>
                    <li><strong>Monthly mortgage payment:</strong> (Price √ó 80% √ó 4.5% interest) √∑ 12 months</li>
                    <li><strong>Monthly expenses:</strong> Property taxes √∑ 12 + maintenance reserve (8% of rent)</li>
                    <li><strong>Monthly cash flow:</strong> Rental income - all monthly expenses</li>
                    <li><strong>Cash-on-Cash Return:</strong> (Annual cash flow √∑ Down payment) √ó 100</li>
                    <li><strong>Cap Rate:</strong> (Annual rental income √∑ Purchase price) √ó 100</li>
                    <li><strong>Profitability filter:</strong> Only shows properties with positive monthly cash flow</li>
                    <li><strong>NULLIF protection:</strong> Prevents division by zero errors</li>
                </ol>
            </div>

            <div class="technical-note">
                <h4>üîß Financial Assumptions:</h4>
                <ul>
                    <li><strong>Down Payment</strong>: 20% of purchase price</li>
                    <li><strong>Interest Rate</strong>: 4.5% for mortgage calculations</li>
                    <li><strong>Maintenance Reserve</strong>: 8% of rental income</li>
                    <li><strong>Profitability Filter</strong>: Only positive cash flow properties</li>
                </ul>
            </div>
        </div>

        <!-- Query 4 -->
        <div id="query4">
            <h2>Query 4: Market Trends Analysis</h2>
            <div class="difficulty-medium">
                <strong>Difficulty Level: MEDIUM</strong> | Time series analysis with window functions
            </div>

            <h3>Business Purpose</h3>
            <p>Analyzes historical market trends, seasonal patterns, and market velocity to identify optimal buying/selling periods and market temperature across different regions.</p>

            <div class="business-impact">
                <h4>üìà Market Intelligence:</h4>
                <ul>
                    <li><strong>Quarterly Trends</strong>: Quarter-over-quarter price changes</li>
                    <li><strong>Seasonal Patterns</strong>: Best months to buy/sell properties</li>
                    <li><strong>Market Temperature</strong>: Hot/Warm/Cold market classification</li>
                    <li><strong>Velocity Indicators</strong>: Days on market analysis</li>
                </ul>
            </div>

            <div class="business-impact">
                <strong>Business Question:</strong> When is the optimal time to buy or sell properties based on historical trends and market conditions?
            </div>

            <div class="query-block">
                <h4>Time Series and Trend Analysis</h4>
                <div class="sql-code">-- Historical price trends with quarter-over-quarter changes
WITH quarterly_trends AS (
    SELECT 
        EXTRACT(YEAR FROM listing_date) as year,
        EXTRACT(QUARTER FROM listing_date) as quarter,
        COUNT(*) as listings_count,
        AVG(price) as avg_price,
        AVG(days_on_market) as avg_days_on_market,
        AVG(price_per_sqft) as avg_price_per_sqft
    FROM properties 
    WHERE listing_date IS NOT NULL 
      AND price > 0 
      AND days_on_market > 0
      AND listing_date >= '2020-01-01'  -- Focus on recent trends
    GROUP BY EXTRACT(YEAR FROM listing_date), EXTRACT(QUARTER FROM listing_date)
)

SELECT 
    year,
    quarter,
    CONCAT('Q', quarter, ' ', year) as period,
    listings_count,
    ROUND(avg_price, 0) as avg_price,
    ROUND(avg_days_on_market, 1) as avg_days_on_market,
    ROUND(avg_price_per_sqft, 2) as avg_price_per_sqft,
    
    -- Quarter-over-quarter price change
    ROUND(
        (avg_price - LAG(avg_price) OVER (ORDER BY year, quarter)) 
        / NULLIF(LAG(avg_price) OVER (ORDER BY year, quarter), 0) * 100, 2
    ) as qoq_price_change_percent,
    
    -- Market velocity indicator (inverse of days on market)
    ROUND(1.0 / NULLIF(avg_days_on_market, 0) * 1000, 2) as market_velocity_index
    
FROM quarterly_trends
ORDER BY year DESC, quarter DESC;

-- Market heat analysis by region
SELECT 
    state,
    city,
    COUNT(*) as total_listings,
    AVG(days_on_market) as avg_days_on_market,
    AVG(price) as avg_price,
    
    -- Market classification
    CASE 
        WHEN AVG(days_on_market) <= 30 THEN 'Hot Market'
        WHEN AVG(days_on_market) <= 60 THEN 'Warm Market'  
        WHEN AVG(days_on_market) <= 90 THEN 'Balanced Market'
        ELSE 'Cold Market'
    END as market_temperature,
    
    -- Supply-demand indicator
    ROUND(COUNT(*) / NULLIF(AVG(days_on_market), 0), 2) as supply_demand_ratio
    
FROM properties 
WHERE listing_date >= CURRENT_DATE - INTERVAL '12 months'
  AND days_on_market > 0
GROUP BY state, city
HAVING COUNT(*) >= 10  -- Only cities with significant data
ORDER BY avg_days_on_market ASC
LIMIT 20;</div>
            </div>

            <div class="explanation">
                <h4>üîç Step-by-Step Explanation:</h4>
                <ol>
                    <li><strong>EXTRACT(YEAR/QUARTER):</strong> Groups data by time periods for trend analysis</li>
                    <li><strong>CTE quarterly_trends:</strong> Calculates quarterly averages for price and market metrics</li>
                    <li><strong>LAG() window function:</strong> Compares current quarter to previous quarter</li>
                    <li><strong>QoQ price change:</strong> (Current - Previous) √∑ Previous √ó 100 for % change</li>
                    <li><strong>Market velocity index:</strong> Higher values = faster sales (hot market)</li>
                    <li><strong>Market temperature classification:</strong> Based on average days on market</li>
                    <li><strong>Supply-demand ratio:</strong> Listings count √∑ days on market</li>
                    <li><strong>12-month filter:</strong> Focus on recent market conditions</li>
                </ol>
            </div>

            <div class="highlight">
                <strong>üìä Market Timing Strategy:</strong> Hot markets (< 30 days) indicate seller's markets with high competition. Investors should focus on warm markets (30-60 days) for better negotiation opportunities.
            </div>
        </div>

        <!-- Query 5 -->
        <div id="query5">
            <h2>Query 5: Advanced Investment Scoring Algorithm</h2>
            <div class="difficulty-hard">
                <strong>Difficulty Level: MEDIUM-HARD</strong> | Multi-CTE complex business logic
            </div>

            <h3>Business Purpose</h3>
            <p>Comprehensive investment scoring system that combines financial metrics, location desirability, market conditions, and risk factors to rank investment opportunities and provide actionable recommendations.</p>

            <div class="business-impact">
                <h4>üéØ Advanced Investment Intelligence:</h4>
                <ul>
                    <li><strong>Multi-Factor Scoring</strong>: 5-component weighted algorithm (Cash Flow 25%, Cap Rate 20%, Location 25%, Market 15%, Value 15%)</li>
                    <li><strong>Risk Assessment</strong>: Automated risk level classification</li>
                    <li><strong>Investment Recommendations</strong>: Strong Buy/Buy/Consider/Marginal/Avoid</li>
                    <li><strong>Transparency</strong>: Score breakdown for decision justification</li>
                </ul>
            </div>

            <div class="business-impact">
                <strong>Business Question:</strong> Which properties offer the highest overall investment potential when considering multiple factors like cash flow, location quality, market conditions, and value proposition?
            </div>

            <div class="query-block">
                <h4>Multi-Factor Investment Scoring Algorithm</h4>
                <div class="sql-code">WITH property_metrics AS (
    SELECT 
        p.*,
        m.avg_area_price,
        m.market_trend,
        m.area_appreciation_rate,
        e.unemployment_rate,
        e.crime_rate,
        e.school_rating,
        
        -- Financial metrics
        (p.estimated_rental_income * 12) as annual_rental_income,
        (p.price * 0.20) as down_payment,
        (p.estimated_rental_income * 12 / NULLIF(p.price, 0) * 100) as cap_rate,
        
        -- Location metrics  
        (p.price / NULLIF(m.avg_area_price, 0)) as price_to_area_avg_ratio,
        
        -- Cash flow calculations
        (p.estimated_rental_income - 
         (p.price * 0.80 * 0.045 / 12) -  -- Mortgage payment
         (p.property_taxes / 12) -         -- Monthly taxes
         (p.estimated_rental_income * 0.10) -- Maintenance/vacancy reserve
        ) as monthly_cash_flow
        
    FROM properties p
    LEFT JOIN market_data m ON p.zip_code = m.zip_code
    LEFT JOIN economic_indicators e ON p.zip_code = e.zip_code
    WHERE p.price > 0 
      AND p.estimated_rental_income > 0
      AND p.square_feet > 0
),

scored_properties AS (
    SELECT 
        *,
        
        -- Scoring components (0-100 scale each)
        
        -- 1. Cash Flow Score (25% weight)
        CASE 
            WHEN monthly_cash_flow <= 0 THEN 0
            WHEN monthly_cash_flow >= 1000 THEN 100
            ELSE ROUND(monthly_cash_flow / 10, 0)
        END as cash_flow_score,
        
        -- 2. Cap Rate Score (20% weight) 
        CASE 
            WHEN cap_rate <= 3 THEN 20
            WHEN cap_rate >= 12 THEN 100
            ELSE ROUND(20 + (cap_rate - 3) * 80 / 9, 0)
        END as cap_rate_score,
        
        -- 3. Location Desirability Score (25% weight)
        ROUND(
            (CASE WHEN school_rating IS NOT NULL THEN school_rating ELSE 5 END * 10) +  -- School rating (0-10 scale)
            (CASE 
                WHEN crime_rate <= 2 THEN 30
                WHEN crime_rate <= 5 THEN 20  
                WHEN crime_rate <= 8 THEN 10
                ELSE 0 
            END) +  -- Crime safety score
            (CASE 
                WHEN unemployment_rate <= 3 THEN 20
                WHEN unemployment_rate <= 6 THEN 15
                WHEN unemployment_rate <= 10 THEN 10
                ELSE 5
            END), 0  -- Economic stability score
        ) as location_score,
        
        -- 4. Market Conditions Score (15% weight)
        CASE 
            WHEN market_trend = 'Strong Growth' THEN 90
            WHEN market_trend = 'Moderate Growth' THEN 70
            WHEN market_trend = 'Stable' THEN 50
            WHEN market_trend = 'Declining' THEN 20
            ELSE 40
        END as market_score,
        
        -- 5. Value Score - Price relative to area (15% weight)
        CASE 
            WHEN price_to_area_avg_ratio <= 0.8 THEN 100  -- 20% below area average
            WHEN price_to_area_avg_ratio <= 0.9 THEN 80   -- 10% below area average  
            WHEN price_to_area_avg_ratio <= 1.1 THEN 60   -- Within 10% of average
            WHEN price_to_area_avg_ratio <= 1.2 THEN 40   -- 20% above average
            ELSE 20  -- More than 20% above average
        END as value_score
        
    FROM property_metrics
    WHERE monthly_cash_flow IS NOT NULL
),

final_scoring AS (
    SELECT 
        property_id,
        address,
        city,
        state,
        zip_code,
        price,
        bedrooms,
        bathrooms,
        square_feet,
        estimated_rental_income,
        monthly_cash_flow,
        cap_rate,
        
        -- Individual scores
        cash_flow_score,
        cap_rate_score, 
        location_score,
        market_score,
        value_score,
        
        -- Weighted composite score
        ROUND(
            (cash_flow_score * 0.25) +
            (cap_rate_score * 0.20) +
            (location_score * 0.25) +
            (market_score * 0.15) +
            (value_score * 0.15), 1
        ) as composite_investment_score,
        
        -- Risk assessment
        CASE 
            WHEN monthly_cash_flow < 200 THEN 'High Risk'
            WHEN cap_rate < 5 THEN 'Medium-High Risk'
            WHEN location_score < 40 THEN 'Medium Risk'
            WHEN market_score < 50 THEN 'Medium Risk'
            ELSE 'Low-Medium Risk'
        END as risk_level,
        
        -- Investment recommendation
        CASE 
            WHEN monthly_cash_flow > 400 AND cap_rate > 7 AND location_score > 60 THEN 'Strong Buy'
            WHEN monthly_cash_flow > 200 AND cap_rate > 6 AND location_score > 50 THEN 'Buy' 
            WHEN monthly_cash_flow > 100 AND cap_rate > 5 THEN 'Consider'
            WHEN monthly_cash_flow > 0 THEN 'Marginal'
            ELSE 'Avoid'
        END as investment_recommendation
        
    FROM scored_properties
)

SELECT 
    property_id,
    address,
    city,
    state,
    zip_code,
    CONCAT('$', FORMAT(price, 0)) as formatted_price,
    bedrooms,
    bathrooms,
    square_feet,
    CONCAT('$', FORMAT(estimated_rental_income, 0)) as monthly_rent,
    CONCAT('$', FORMAT(monthly_cash_flow, 0)) as monthly_cash_flow,
    ROUND(cap_rate, 2) as cap_rate_percent,
    composite_investment_score,
    risk_level,
    investment_recommendation,
    
    -- Score breakdown for transparency
    CONCAT(
        'CF:', cash_flow_score, ' ',
        'CR:', cap_rate_score, ' ', 
        'LOC:', location_score, ' ',
        'MKT:', market_score, ' ',
        'VAL:', value_score
    ) as score_breakdown
    
FROM final_scoring
WHERE composite_investment_score > 50  -- Only show decent opportunities
ORDER BY composite_investment_score DESC, monthly_cash_flow DESC
LIMIT 30;</div>
            </div>

            <div class="explanation">
                <h4>üîç Step-by-Step Explanation:</h4>
                <ol>
                    <li><strong>Multi-CTE Structure:</strong> Three levels of data transformation for complex scoring</li>
                    <li><strong>property_metrics CTE:</strong> Calculates base financial and location metrics</li>
                    <li><strong>scored_properties CTE:</strong> Applies scoring logic (0-100) for each component</li>
                    <li><strong>Cash Flow Score (25%):</strong> $1000+ monthly = 100 points, scaled down proportionally</li>
                    <li><strong>Cap Rate Score (20%):</strong> 12%+ cap rate = 100 points, 3% = 20 points</li>
                    <li><strong>Location Score (25%):</strong> Combines school rating + crime safety + economic stability</li>
                    <li><strong>Market Score (15%):</strong> Growth trend classification (Strong/Moderate/Stable/Declining)</li>
                    <li><strong>Value Score (15%):</strong> Price relative to area average (below average = higher score)</li>
                    <li><strong>Weighted Composite:</strong> Combines all scores with business-priority weighting</li>
                    <li><strong>Risk Classification:</strong> Automated risk assessment based on key metrics</li>
                    <li><strong>Investment Recommendations:</strong> Strong Buy/Buy/Consider/Marginal/Avoid categories</li>
                </ol>
            </div>

            <div class="technical-note">
                <h4>üîß Algorithm Components:</h4>
                <ul>
                    <li><strong>Cash Flow Score (25%)</strong>: 0-100 scale based on monthly cash flow ($1000+ = 100)</li>
                    <li><strong>Cap Rate Score (20%)</strong>: Scaled from 3% (score=20) to 12%+ (score=100)</li>
                    <li><strong>Location Score (25%)</strong>: School ratings + crime safety + economic stability</li>
                    <li><strong>Market + Value (30%)</strong>: Market conditions and price-to-area ratios</li>
                </ul>
            </div>
        </div>

        <!-- Technical Details -->
        <div id="technical-details">
            <h2>üîß Technical Implementation Details</h2>
            
            <div class="technical-note">
                <h3>Database Schema</h3>
                <div class="sql-code">
<span class="sql-keyword">CREATE TABLE</span> properties (
    property_id <span class="sql-keyword">INTEGER PRIMARY KEY</span>,
    address <span class="sql-keyword">TEXT</span>,
    city <span class="sql-keyword">TEXT</span>,
    state <span class="sql-keyword">TEXT</span>,
    zip_code <span class="sql-keyword">TEXT</span>,
    price <span class="sql-keyword">REAL</span>,
    bedrooms <span class="sql-keyword">INTEGER</span>,
    bathrooms <span class="sql-keyword">REAL</span>,
    square_feet <span class="sql-keyword">INTEGER</span>,
    property_type <span class="sql-keyword">TEXT</span>,
    estimated_rental_income <span class="sql-keyword">REAL</span>,
    property_taxes <span class="sql-keyword">REAL</span>,
    listing_date <span class="sql-keyword">DATE</span>,
    days_on_market <span class="sql-keyword">INTEGER</span>,
    price_per_sqft <span class="sql-keyword">REAL</span>
);
                </div>
            </div>

            <div class="query-block">
                <h3>SQL Techniques Demonstrated</h3>
                <ul>
                    <li><strong>Common Table Expressions (CTEs)</strong>: Multi-level data transformation</li>
                    <li><strong>Window Functions</strong>: LAG() for time series analysis</li>
                    <li><strong>Complex CASE Statements</strong>: Business logic implementation</li>
                    <li><strong>Aggregate Functions</strong>: Statistical analysis and grouping</li>
                    <li><strong>Data Quality Filters</strong>: Outlier handling and validation</li>
                    <li><strong>Mathematical Calculations</strong>: Financial formulas and scoring</li>
                    <li><strong>String Formatting</strong>: Professional output presentation</li>
                </ul>
            </div>
        </div>

        <!-- Business Applications -->
        <div id="business-applications">
            <h2>üíº Business Applications</h2>
            
            <div class="business-impact">
                <h3>üéØ Investment Decision Framework</h3>
                <ol>
                    <li><strong>Market Screening</strong>: Use Query 1-2 for initial market assessment</li>
                    <li><strong>Financial Analysis</strong>: Apply Query 3 for ROI calculations</li>
                    <li><strong>Timing Strategy</strong>: Leverage Query 4 for market timing</li>
                    <li><strong>Final Selection</strong>: Use Query 5 for investment ranking</li>
                </ol>
            </div>

            <div class="highlight">
                <h3>üìä Key Performance Indicators</h3>
                <ul>
                    <li><strong>Target Cap Rate</strong>: 8%+ for strong investments</li>
                    <li><strong>Minimum Cash Flow</strong>: $200+ monthly for sustainability</li>
                    <li><strong>Market Temperature</strong>: Focus on Warm markets (30-60 days)</li>
                    <li><strong>Investment Score</strong>: 70+ for "Strong Buy" recommendations</li>
                </ul>
            </div>

            <div class="business-impact">
                <h3>üó∫Ô∏è Geographic Strategy</h3>
                <p><strong>Diversification Approach:</strong> Spread investments across 3+ states to minimize regional market risk while focusing on markets with strong fundamentals (employment, population growth, rental demand).</p>
            </div>
        </div>

        <div class="author-info">
            <h3>üë®‚Äçüíº About the Author</h3>
            <p><strong>Salom√≥n Santiago</strong><br>
            Data Analyst & Business Intelligence Specialist<br>
            üìß salo.santiago96@gmail.com | üîó <a href="https://linkedin.com/in/salomon-santiago-493002a7">LinkedIn</a> | üíº <a href="https://salo996.github.io/Data-analyst-portfolio/">Portfolio</a></p>
            
            <p><em>Specialized in transforming complex real estate data into actionable investment strategies through advanced SQL analytics and business intelligence.</em></p>
        </div>
    </div>
</body>
</html>